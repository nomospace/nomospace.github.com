<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Watermark.js for NodeJS</title>
</head>
<body>
<div class="nbw-bitm bdwb bds2 bdc0 ">
<div class="multicntwrap">
    <div class="multicnt">
        <div>
            <h3 class="title pre fs1"><span class="tcnt">Watermark.js for NodeJS</span>&nbsp;&nbsp;<span
                    class="bgc0 fc07 fw0 fs0"></span></h3>

            <p class="tdep clearfix nbw-act fc06" style="line-height:20px;">
		        <span class="pleft">

		          <span class="blogsep">2011-06-22 17:25:23</span><span class="blogsep">|&nbsp;&nbsp;分类：</span>
		          <a class="fc03 m2a"
                     href="http://blog.163.com/jinlu_hz/blog/#m=0&amp;t=1&amp;c=fks_084065093081085075083095082095085087082075087086087070086"
                     title="Node.js">Node.js</a>
		          <span class="blogsep phide" id="$_blogTagTitle">|&nbsp;&nbsp;标签：</span><span class="fc03 phide"
                                                                                               id="$_blogTagInfo"></span>
		        </span>
                    <span class="pright fc07 ztag"><span class="blogsep">|</span><span class="zihao fc03"
                                                                                       id="$_fontswitch">字号<span
                            class="zihaoshow  phide" id="$_fontsTypes"><span class="zihaoc bdc0"><span
                            class="stag"></span><span class="fc04 stag">大</span><span
                            class="fc04 stag selected js-fcurrent fc05">中</span><span class="fc04 stag">小</span></span></span></span></span><span
                    class="pright pnt fc03" id="$_blog_subscribe"><span class="iblock icn0 icn0-919">&nbsp;</span><a
                    class="m2a">订阅</a></span>
            </p>
        </div>
    </div>
</div>

<div>

</div>

<div class="nbw-blog-start"></div>
<div class="bct fc05 fc11 nbw-blog ztag js-fs2">感谢<a target="_blank" rel="nofollow"
                                                     href="https://github.com/LearnBoost">LearnBoost</a>团队对<a
        target="_blank" rel="nofollow" href="https://github.com/LearnBoost/node-canvas">node-canvas</a>的研究以及<a
        target="_blank" rel="nofollow" href="http://www.patrick-wied.at/">Patrick Wied</a>的<a target="_blank"
                                                                                              rel="nofollow"
                                                                                              href="https://github.com/pa7/watermark.js">watermark.js</a>
project，我在两者基础上进行整合并尝试将watermark.js移植到NodeJS下，借此实现给指定目录下的所有图片打上水印。简单说下技术要点和实现原理。<br><b><br>如何制作水印？</b><br><br>根据<a
        target="_blank" rel="nofollow"
        href="http://letmein.at/js/how-to-create-transparency-in-images-with-html5canvas/">Patrick Wied
    watermark.js的指导</a>，可简单分为三个步骤。<br><br>第一步，把水印图片画到canvas上。由于在NodeJS中运行，于是对其稍作修改：<br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><ol
        start="1"
        style="font-size: 1em; line-height: 1.4em; margin-top: 0px; margin-right: 0px; margin-bottom: 1px; margin-left: 0px; padding-top: 2px; padding-right: 0px; padding-bottom: 2px; padding-left: 0px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(209, 215, 220); border-right-color: rgb(209, 215, 220); border-bottom-color: rgb(209, 215, 220); border-left-color: rgb(209, 215, 220); list-style-type: decimal; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(43, 145, 175);">
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span
                        style="color: rgb(0, 130, 0);">//&nbsp;获取img元素对象，并设置srcPath</span><span style="color: black;">&nbsp;&nbsp;</span></span>
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">var</span><span
                        style="color: black;">&nbsp;img&nbsp;=&nbsp;</span><span
                        style="color: rgb(127, 0, 85); font-weight: bold;">new</span><span style="color: black;">&nbsp;Image;&nbsp;&nbsp;</span></span>
    </li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">img.src&nbsp;=&nbsp;srcPath;&nbsp; <br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;创建canvas元素对象</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;">canvas&nbsp;=&nbsp;<span style="color: rgb(127, 0, 85); font-weight: bold;">new</span><span
                        style="color: black;">&nbsp;Canvas;&nbsp; <br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><span style=" color: black;"><br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;获取canvas上下文</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;">ctx&nbsp;=&nbsp;canvas.getContext(<span
                        style="color: blue;">"2d"</span><span style="color: black;">);&nbsp; <br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><span style=" color: black;"><br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span
                        style="color: rgb(0, 130, 0);">//&nbsp;设置canvas元素宽高，一般来说与img元素尺寸相同即可</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">canvas.width&nbsp;=&nbsp;img.width;&nbsp;&nbsp;</span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">canvas.height&nbsp;=&nbsp;img.height;&nbsp; <br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;在canvas中描绘img元素</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">ctx.drawImage(img,&nbsp;0,&nbsp;0);</span></li>
</ol></span></span></span></span><br>srcPath可以是一段url、绝对路径或者相对路径，关于path详细参考<a target="_blank" rel="nofollow"
                                                                             href="http://cnodejs.org/cman/path.html">Node.js
    Manual</a>。<br><br>第二步，修改水印图片的透明度：<br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><ol
        start="1"
        style="font-size: 1em; line-height: 1.4em; margin-top: 0px; margin-right: 0px; margin-bottom: 1px; margin-left: 0px; padding-top: 2px; padding-right: 0px; padding-bottom: 2px; padding-left: 0px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(209, 215, 220); border-right-color: rgb(209, 215, 220); border-bottom-color: rgb(209, 215, 220); border-left-color: rgb(209, 215, 220); list-style-type: decimal; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(43, 145, 175);">
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;获取imageData对象</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">var</span><span
                        style="color: black;">&nbsp;image&nbsp;=&nbsp;ctx.getImageData(0,&nbsp;0,&nbsp;500,&nbsp;200);&nbsp; <br></span></span>
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><span style=" color: black;"><br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;获取imageData对象值</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">var</span><span
                        style="color: black;">&nbsp;imageData&nbsp;=&nbsp;image.data,&nbsp;length&nbsp;=&nbsp;imageData.length;&nbsp; <br></span></span>
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><span style=" color: black;"><br></span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;imageData中一个像素包含四个值，分别是R/G/B和alpha(rgba)，故此处循环时每隔4改变一次imageData对应的alpha值（0&nbsp;&lt;=&nbsp;alpha&nbsp;&lt;=&nbsp;255）</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">for</span><span
                        style="color: black;">&nbsp;(</span><span
                        style="color: rgb(127, 0, 85); font-weight: bold;">var</span><span style="color: black;">&nbsp;i&nbsp;=&nbsp;3;&nbsp;i&nbsp;&lt;&nbsp;length;&nbsp;i&nbsp;+=&nbsp;4)&nbsp;{&nbsp;&nbsp;</span></span>
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">&nbsp;&nbsp;&nbsp;&nbsp;imageData[i]&nbsp;=&nbsp;50;&nbsp;&nbsp;</span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">}&nbsp; <br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;重置数据</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">image.data&nbsp;=&nbsp;imageData;&nbsp; <br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style=" color: black;"><br></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(0, 130, 0);">//&nbsp;将其重新置于canvas中</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">ctx.putImageData(image,&nbsp;0,&nbsp;0); <br></span></li>
</ol></span></span><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"></span></span>第三步，给图片设置转化后的dataUrl：<span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="background-color: rgb(192, 192, 192);">img</span></span></span><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="background-color: rgb(192, 192, 192);">.src&nbsp;=&nbsp;canvas.toDataURL();</span></span></span>，以此获得调整过的img对象。<br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"></span></span><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><ol
        start="1"
        style="font-size: 1em; line-height: 1.4em; margin-top: 0px; margin-right: 0px; margin-bottom: 1px; margin-left: 0px; padding-top: 2px; padding-right: 0px; padding-bottom: 2px; padding-left: 0px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(209, 215, 220); border-right-color: rgb(209, 215, 220); border-bottom-color: rgb(209, 215, 220); border-left-color: rgb(209, 215, 220); list-style-type: decimal; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(43, 145, 175);">
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
                        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
                        style="color: black;"><span
                        style="color: black;">img.src = canvas.toDataURL();</span></span></span></span><br><span
            style="color: black;"><span style="color: black;"></span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;"><span style="color: black;">ctx.drawImage(</span></span><span
            style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
            style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
            style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
            style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
            style="color: black;"><span style="color: black;">img</span></span></span></span></span></span><span
            style="color: black;"><span style="color: black;">, 0, 0); <br></span></span></li>
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
                        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
                        style="color: black;"><span
                        style="color: black;">ctx.drawImage(originImage,&nbsp;x,&nbsp;y); </span></span></span></span>
    </li>
</ol></span></span><br>把两张图片画在canvas不同的位置，最终实现了打水印。<br><br><font color="#808080">TODO：<span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="background-color: rgb(192, 192, 192);">watermarkImage.src&nbsp;= </span></span></span><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="background-color: rgb(192, 192, 192);">canvas</span></span></span><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Tahoma; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="background-color: rgb(192, 192, 192);">.toDataURL();</span>，</span></span>这段代码将toDataURL转换后的base64值作为src赋给watermarkImage，在NodeJS下并不会触发image元素的onload事件（即加载失败），但在浏览器环境下却能正常加载。最终导致在NodeJS环境下无法打出具有一定透明度的水印。</font><br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"></span></span><b>如何保存打过水印的新图片？<br><br></b>这个问题很简单，node-canvas提供了<span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium; background-color: rgb(192, 192, 192);"><span
        style="font-family: Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size: 12px; line-height: 18px; text-align: left;"><span
        style="color: black;">createSyncPNGStream</span></span></span>接口，该接口扩展自<a target="_blank" rel="nofollow"
                                                                                  href="http://cnodejs.org/cman/streams.html#streams_">Stream</a>，用来保存PNG流：<br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><ol
        start="1"
        style="font-size: 1em; line-height: 1.4em; margin-top: 0px; margin-right: 0px; margin-bottom: 1px; margin-left: 0px; padding-top: 2px; padding-right: 0px; padding-bottom: 2px; padding-left: 0px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(209, 215, 220); border-right-color: rgb(209, 215, 220); border-bottom-color: rgb(209, 215, 220); border-left-color: rgb(209, 215, 220); list-style-type: decimal; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(43, 145, 175);">
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">var</span><span
                        style="color: black;">&nbsp;out&nbsp;=&nbsp;fs.createWriteStream(imagePath&nbsp;+&nbsp;</span><span
                        style="color: blue;">'.watermark.png'</span><span
                        style="color: black;">),&nbsp;&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        <span style="color: black;">&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;=&nbsp;canvas.createSyncPNGStream();&nbsp;&nbsp;</span>
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;">stream.on(<span style="color: blue;">'data'</span><span
                        style="color: black;">,&nbsp;</span><span style="color: rgb(127, 0, 85); font-weight: bold;">function</span><span
                        style="color: black;">(chunk){out.write(chunk);});&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;">stream.on(<span style="color: blue;">'end'</span><span
                        style="color: black;">,&nbsp;</span><span style="color: rgb(127, 0, 85); font-weight: bold;">function</span><span
                        style="color: black;">(){out.end();});&nbsp; <br></span></span></li>
</ol></span></span><br>实际效果如图所示：<br>

<div>
    <div><img alt="Watermark.js for NodeJS - 挪墨 - Nomospace" style="margin:0 10px 0 0;"
              src="/2707789275973289468.png"><br><br></div>
</div>
注意此处都是png格式的图片，调试过程中得知node-canvas目前只支持png格式文件的读取、写入，在源代码中也有这么一段：<br><br><span
        style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; font-size: medium;"><span
        style="font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace; font-size: 12px; line-height: 18px; text-align: left;"><ol
        start="1"
        style="font-size: 1em; line-height: 1.4em; margin-top: 0px; margin-right: 0px; margin-bottom: 1px; margin-left: 0px; padding-top: 2px; padding-right: 0px; padding-bottom: 2px; padding-left: 0px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(209, 215, 220); border-right-color: rgb(209, 215, 220); border-bottom-color: rgb(209, 215, 220); border-left-color: rgb(209, 215, 220); list-style-type: decimal; list-style-position: initial; list-style-image: initial; background-color: rgb(255, 255, 255); color: rgb(43, 145, 175);">
    <li style="font-size: 1em; margin: 0px 0px 0px 38px; padding: 0px 0px 0px 10px; border-left: 1px solid rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
        // Canvas.prototype.toDataURL
    </li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span
                        style="color: rgb(0, 130, 0);">//&nbsp;Throw&nbsp;on&nbsp;non-png</span><span
                        style="color: black;">&nbsp;&nbsp;</span></span></li>
    <li style="font-size: 1em; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 38px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 10px; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(209, 215, 220); background-color: rgb(250, 250, 250); line-height: 18px;">
                <span style="color: black;"><span style="color: rgb(127, 0, 85); font-weight: bold;">if</span><span
                        style="color: black;">&nbsp;(</span><span style="color: blue;">'image/png'</span><span
                        style="color: black;">&nbsp;!=&nbsp;type)&nbsp;</span><span
                        style="color: rgb(127, 0, 85); font-weight: bold;">throw</span><span style="color: black;">&nbsp;</span><span
                        style="color: rgb(127, 0, 85); font-weight: bold;">new</span><span style="color: black;">&nbsp;Error(</span><span
                        style="color: blue;">'currently&nbsp;only&nbsp;image/png&nbsp;is&nbsp;supported'</span><span
                        style="color: black;">);</span></span></li>
</ol></span></span><br>有兴趣的读者可以参考<a target="_blank" rel="nofollow"
                                    href="https://github.com/nomospace/nomospace.github.com/tree/master/nomospace.github.com/lab/2011/watermark">watermark
    for NodeJS@github</a>，细节部分不再赘述。<br><br><br>参考资料<br><a target="_blank" rel="nofollow"
                                                          href="http://blog.learnboost.com/blog/introducing-node-canvas-server-side-html5-canvas-api/">Introducing
    node-canvas. Server side HTML5 canvas API</a><br><a target="_blank" rel="nofollow"
                                                        href="http://diveintohtml5.org/canvas.html#divingin">Canvas
    - Dive Into HTML5</a><br><a target="_blank" rel="nofollow"
                                href="https://developer.mozilla.org/en/canvas_tutorial">Canvas tutorial</a>
</div>
<div>
</div>

<div>
</div>


</div>
</body>
</html>
